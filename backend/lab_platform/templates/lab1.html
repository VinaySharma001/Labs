<!DOCTYPE html>
<html>
<head>
  <title>Lab Terminal</title>
  <script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css">
</head>
<body>

<h2>Lab Terminal</h2>
<button id="startBtn">Start Lab</button>

<div id="terminal" style="width:100%;height:400px;border:2px solid black;display:none;"></div>

<script>
let term;
let ws;

document.getElementById("startBtn").addEventListener("click", async function(event) {
  event.preventDefault();

  try {
    const res = await fetch("http://127.0.0.1:8000/api/start/");
    
    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }
    
    const data = await res.json();
    console.log("API response:", data);

    if (!data.container_name) {
      throw new Error("Container name not found in response. Response: " + JSON.stringify(data));
    }

    const cname = data.container_name;
    console.log("Container name:", cname);

    if (!cname || cname === 'undefined' || cname === undefined) {
      throw new Error("Invalid container name: " + cname + ". Full response: " + JSON.stringify(data));
    }

    // Wait a moment for container to be fully ready
    await new Promise(resolve => setTimeout(resolve, 500));

    document.getElementById("terminal").style.display = "block";

  // Initialize terminal with proper options
  term = new Terminal({
    cursorBlink: true,
    fontSize: 14,
    fontFamily: 'Consolas, "Courier New", monospace',
    theme: {
      background: '#000000',
      foreground: '#ffffff'
    },
    disableStdin: false,  // Ensure input is enabled
    cursorStyle: 'block'
  });
  
  const terminalElement = document.getElementById("terminal");
  term.open(terminalElement);
  
  // Ensure terminal is focused
  setTimeout(() => {
    term.focus();
    console.log("Terminal focused");
  }, 100);

  // Use the same port as the HTTP server (8000) or adjust if using different port
  const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
  const wsHost = window.location.hostname || '127.0.0.1';
  const wsPort = window.location.port || '8000';
  const wsUrl = `${wsProtocol}//${wsHost}:${wsPort}/ws/lab/${cname}/`;
  
  console.log("Connecting to WebSocket:", wsUrl);
  ws = new WebSocket(wsUrl);

  ws.onopen = function() {
    term.write("\r\n[WebSocket connected]\r\n");
    term.focus();
    console.log("WebSocket connected successfully");
  };

  ws.onerror = function(error) {
    term.write("\r\n[WebSocket connection error - check console for details]\r\n");
    console.error("WebSocket error:", error);
    console.error("WebSocket URL was:", wsUrl);
    console.error("WebSocket readyState:", ws.readyState);
  };

  ws.onclose = function(event) {
    term.write(`\r\n[WebSocket connection closed - Code: ${event.code}, Reason: ${event.reason || 'none'}]\r\n`);
    console.log("WebSocket closed:", event.code, event.reason);
  };

  ws.onmessage = function(e) {
    console.log("Received from server:", e.data, "Type:", typeof e.data, "Length:", e.data.length);
    term.write(e.data);
  };

  term.onData(function(data) {
    console.log("Terminal data to send:", data, "Type:", typeof data, "Length:", data.length);
    if(ws && ws.readyState === WebSocket.OPEN) {
      console.log("Sending data via WebSocket");
      ws.send(data);
    } else {
      console.warn("WebSocket not ready. State:", ws ? ws.readyState : "null");
    }
  });
  
  // Ensure terminal is focused and can receive input
  term.focus();
  
  // Add click handler to focus terminal when clicked
  document.getElementById("terminal").addEventListener("click", function() {
    term.focus();
  });
  
  } catch (error) {
    console.error("Error starting lab:", error);
    alert("Error starting lab: " + error.message + "\n\nCheck console for details.");
    
    // Show error in terminal if it exists
    if (term) {
      term.write("\r\n[ERROR: " + error.message + "]\r\n");
    }
  }
});
</script>

</body>
</html>
